<!-- Page: Preparing_Windows_for_Dual-Booting -->

As shipped, a typical Windows 10 (or Windows 8) installation spans its host machine's entire drive.

Accordingly, our first order of business is to shrink the size of the Windows C: partition, thereby freeing up some space on which to install our new Gentoo system.

The good news is that Windows already contains the necessary tools to shrink partitions. The not-so-good news is that Windows also sprinkles various files around the drive (for hibernation, paging and system restore), such that even if you have just started using the machine, without some additional work you can only reclaim about half of your C: drive for Linux.

But, fear not: the instructions below will show you how to get around this restriction.<ref>Download 3K: [http://www.download3k.com/articles/How-to-shrink-a-disk-volume-beyond-the-point-where-any-unmovable-files-are-located-00432 "How to shrink a disk volume beyond the point where any unmovable files are located"]</ref>

{{Note|A similar process may be used to free up space in a Windows 7 system too.<ref>SuperUser Forum: [http://superuser.com/questions/88131/how-to-shrink-windows-7-boot-partition-with-unmovable-files "How to shrink Windows 7 boot partition with unmovable files"]</ref>}}

== <span id="win_dual_boot_prep">Shrinking Windows' Disk Footprint</span> ==

Boot your target machine into Windows as normal, and login to your account (which must have administrator rights - the first user created on a new Windows install has these by default). Next, perform the following steps (I have noted where things differ between Windows 10, 8.1 and 8):
{{Note|For Windows 10 users, the following assumes you are logged in with a local account and have options like "Search online and include web results" and Cortana turned off.<ref>Gizmodo UK: [http://www.gizmodo.co.uk/2015/11/windows-10-privacy-settings-what-you-need-to-know/ "Windows 10 Privacy Settings: What You Need to Know"]</ref> If you are running Windows 10 with more permissive settings, be sure to choose the correct item from those returned when directed to perform a search in the following instructions. The correct items will generally be tagged as "Control panel" or "Desktop app".}}

# Ensure you have '''backups''' of everything important. Last chance ^-^
# Done that? OK then, to begin with, we'll {{Highlight|turn off system protection (restore points)}}.<ref>Ubuntu Forums: [http://ubuntuforums.org/showthread.php?t=2087466#post_message_12372055 "shrinking Windows 8 partition for dual boot"]</ref> Hit the {{Key|Windows Key}}, which will bring up the start menu in Windows 10 (or the "start screen" in Windows 8.1 and 8), and type <code>restore point</code>. Then click on the 'Create a restore point' item which appears (in Windows 10 and 8.1; Windows 8 users will need to click the 'Settings' icon to see this result). You will now be presented with a dialog box with 'System Protection' as the selected tab. Choose the relevant drive (generally, C:). Click the 'Configure...' button. Another dialog pops up - click on the 'Disable system protection' radio button, and click 'OK'. When asked if you are sure, click 'Yes'. (N.B., this will remove existing restore points from the drive, if any; if they are important to you, do not perform this step.) Close out the other dialogs by clicking on 'OK'.
# Next, we'll {{Highlight|turn off the virtual memory paging file}}. Hit the {{Key|Windows Key}}, which will bring up the start menu in Windows 10 (or the "start screen" in Windows 8.1 and 8), and type <code>adjust the appearance</code>. Then click on the 'Adjust the appearance and performance of Windows' item that appears (in Windows 10 and 8.1; Windows 8 users will again need to click the 'Settings' icon to see this result). You will now be presented with a 'Performance Options' dialog; select the 'Advanced' tab in it. In the virtual memory area, click on 'Change...', and, in the dialog that next appears, untick 'Automatically manage paging file size for all drives', then choose the relevant drive (generally, C:), select the 'No paging file' radio button and click 'Set'. You'll get warnings about the problems this can cause; if happy to proceed select 'Yes', then choose 'OK' again to close out the Virtual Memory dialog itself. If you get a warning about needing to reboot, accept this (but don't reboot yet). Then close out any remaining dialogs.
# Now to {{Highlight|turn off hibernation}}. This is most easily done from the Windows command line. Hit the {{Key|Windows Key}} , which will bring up the start menu in Windows 10 (or the "start screen" in Windows 8.1 and 8), and type <code>command</code>. Now ''right-click'' on the 'Command Prompt' icon that appears, then click on 'Run as administrator' item in the context menu (in Windows 10 and 8.1; it appears at the bottom of the screen in Windows 8). If asked whether you wish to proceed, click 'Yes'. You will be presented with an open command window. Now enter <code>powercfg /H off</code>. After this, hit {{Key|Ctrl}}{{Key|Alt}}{{Key|Delete}}, then click on the power icon at the bottom right of the screen, and choose 'Restart' from the pop-up menu.
# Allow the machine to reboot back into Windows, and log in again.
# Now we will {{Highlight|defragment the drive}}. Hit the {{Key|Windows Key}}, which will bring up the start menu in Windows 10 (or the "start screen" in Windows 8.1 and 8), and type <code>defragment</code>. Then click on the 'Defragment and Optimize Drives' item that appears (in Windows 10; in Windows 8.1 and 8 the required item is named 'Defragment and optimize your drives'). Select the C: drive in the dialog box that appears, and select 'Optimize' (this will defragment the drive). When it has completed, click the 'Close' button to dismiss the dialog.
# Follow the process described earlier to reboot and log in again to Windows. (Without this reboot, the shrink step below may fail.)
# Finally, we are ready to <span id="shrink_windows_partition">{{Highlight|shrink the Windows partition}}</span>.<ref>Liberian Geek: [http://www.liberiangeek.net/2012/11/shrink-resize-partitions-in-windows-8/ "Shrink / Resize Partitions in Windows 8"]</ref> Hit {{Key|Windows Key}}, which will bring up the start menu in Windows 10 (or the "start screen" in Windows 8.1 and 8), and type <code>partitions</code>. Then click on the 'Create and format hard disk partitions' item that appears (in Windows 10 and 8.1; Windows 8 users will again need to click the 'Settings' icon to see this result). ''Right click'' on the C: partition in the display for Disk0 at the bottom of the 'Disk Management' dialog that appears, and select 'Shrink Volume...' from the context menu. Another dialog entitled 'Shrink C:' appears. If all has gone according to plan with the changes above, you should now be able to enter quite a large amount of shrink space: enter (as you wish) anything up to the maximum amount allowed as shown on the dialog:[[File:Win8PartitionShrink.png|thumb|none|400px|Shrinking the C: Partition in Windows]] To proceed, click on 'Shrink'. When the process completes, you should now see an additional 'Unallocated' partition at the end of Disk 0 on the 'Disk Management' dialog, and it should be a meaningful percentage of the drive (note that the partition graphical display is not proportional). Note: as an indication, I was able to create a 195.86GB unallocated partition using this method (on a 238.35GB drive, with the C: partition shrunk to 42.10GB from 237.96GB). [https://en.wiktionary.org/wiki/your_mileage_may_vary YMMV]. {{Note|If you encounter a problem during the shrink operation, for example Windows informing you that there is not enough disk space available to complete the operation, then try performing a shrink of ''half'' of the claimed 'available shrink space', and then immediately repeating if successful.}}{{Note|With certain versions of Windows, you may find that the very end of the disk contains a recovery partition. That's nothing to worry about, just shrink the C: partition as described &mdash; you'll still be able to install Gentoo onto the space you have freed up, even if it does not span completely to the end of the drive.}}{{Note|How much space to free up for Gentoo / leave for Windows will obviously depend upon your particular usage pattern. You should probably aim to free up a ''minimum'' of 20GB or so for Gentoo, however. If you are running Windows 8 or 8.1, and planning to upgrade to Windows 10 in the future, you should ensure that your Windows C: partition has a ''minimum'' of 5GB free space after the shrink.<ref>WindowsCentral: [http://www.windowscentral.com/how-prepare-your-pc-windows-10-upgrade "How to prepare your PC for the Windows 10 upgrade"] (see section "Making space for the upgrade")</ref> (Incidentally, even once Gentoo is co-installed, you ''can'' safely upgrade to Windows 10 without harming the Linux side of things; in this author's experience anyhow.)}}
# For safety, follow the process described earlier to reboot and log in ''again'' to Windows. This ensures that all system processes take note of the new partition boundaries.
# Now we'll revert the changes we made to Windows (other than the partition shrink!), prior to installing Gentoo Linux on our newly reclaimed disk space. First, we'll {{Highlight|turn on hibernation again}}. Hit the {{Key|Windows Key}} , which will bring up the start menu in Windows 10 (or the "start screen" in Windows 8.1 and 8), and type <code>command</code>. Now ''right-click'' on the 'Command Prompt' icon that appears, then click on 'Run as administrator' item in the context menu (in Windows 10 and 8.1; it appears at the bottom of the screen in Windows 8). If asked whether you wish to proceed, click 'Yes'. You will be presented with an open command window. Now enter <code>powercfg /H on</code>. Note that although this enables hibernation, the option to trigger it may still be hidden in the power menu, even after you reboot. We'll fix this shortly.
# Next, let's {{Highlight|activate the virtual memory paging file again}}. Hit the {{Key|Windows Key}}, which will bring up the start menu in Windows 10 (or the "start screen" in Windows 8.1 and 8), and type <code>adjust the appearance</code>. Then click on the 'Adjust the appearance and performance of Windows' item that appears (in Windows 10 and 8.1; Windows 8 users will again need to click the 'Settings' icon to see this result). You will now be presented with a 'Performance Options' dialog; select the 'Advanced' tab in it. In the virtual memory area, click on 'Change...', and, in the dialog that next appears, tick 'Automatically manage paging file size for all drives', then choose 'OK' to close out the Virtual Memory dialog. If you get a warning about needing to reboot, accept this (but don't reboot yet). Close out all the remaining dialogs.
# Now we'll {{Highlight|turn on system protection (restore points) again}}. Hit the {{Key|Windows Key}}, which will bring up the start menu in Windows 10 (or the "start screen" in Windows 8.1 and 8), and type <code>restore point</code>. Then click on the 'Create a restore point' item which appears (in Windows 10 and 8.1; Windows 8 users will again need to click the 'Settings' icon to see this result). You will now be presented with a dialog box with 'System Protection' as the selected tab. Choose the relevant drive (generally, C:). Click the 'Configure...' button. Another dialog pops up - click on the 'Turn on system protection' radio button, and click 'OK'. Close out the other dialogs by clicking on 'OK'.
# Follow the process described earlier to reboot and log in one last time to Windows. Check that everything still works as expected.
# The final step is to ensure that {{Highlight|hibernation shows up on the Windows power menu}}.<ref>AddictiveTips: [http://www.addictivetips.com/windows-tips/how-to-enable-windows-8-hibernate-option/ "How To Enable Windows 8 Hibernate Option"]</ref><ref>Winaero: [http://winaero.com/blog/add-hibernate-to-the-start-menu-in-windows-10/ "Add Hibernate to the Start Menu in Windows 10"]</ref> Hit the {{Key|Windows Key}}, which will bring up the start menu in Windows 10 (or the "start screen" in Windows 8.1 and 8). What you need to do next depends on your Windows version. In Windows 10, type <code>power options</code>, and click on the 'Power Options' item which appears (in newer versions of Windows 10, the item has been renamed; you should click on 'Power & sleep settings' instead); then, click 'Choose what the power button does' in the presented dialog box (in newer versions of Windows 10 you will need to click on 'Additional power settings' to see this dialog; the item you want inside it has been renamed also, to 'Choose what the power buttons do'). In Windows 8.1 or 8, type <code>power buttons</code>, then click on the 'Change what the power buttons do' item that appears (Windows 8 users will again need to click the 'Settings' icon to see this result). For all version of Windows, next click on the 'Change settings that are currently unavailable' link in the 'System Settings' dialog. In response, the dialog will display some 'Shut-down settings' (Windows 10) or 'Power options settings' (Windows 8.1 and 8). Ensure 'Hibernate' (in Windows 10) or 'Show Hibernate' (in Windows 8.1 and 8) is checked. <span id="disable_fast_boot">You should also ensure</span> that the entry 'Turn on fast startup (recommended)' is ''unchecked'' (this entry might be called 'Hybrid Boot', depending on your system version),<ref>ArchLinux Wiki:[https://wiki.archlinux.org/index.php/Windows_and_Arch_Dual_Boot#Fast_Start-Up "Windows and Arch Dual Boot: Fast Start-Up"]</ref> and then click the 'Save Changes' button (if you had to make any modifications). Hibernation should now be an option on the power menu. Hit {{Key|Ctrl}}{{Key|Alt}}{{Key|Delete}}, then click on the power icon at the bottom right of the screen, to make sure. ''Don't'' actually hibernate the machine though, simply cancel back out to the main screen, once you've verified that the item is now present.

== <span id="next_steps">Next Steps</span> ==

Although we're done with our Windows prep work for now, leave the target machine running Windows for the moment. [[../Creating_and_Booting_the_Minimal-Install_Image_on_USB|Click here]] to go to the next chapter, "Creating and Booting the Minimal-Install Image on USB".

== <span id="notes">Notes</span> ==
{{reflist}}

{| class="wikitable" style="margin: 1em auto 1em auto;"
|-
| [[../Installation_Prerequisites|< Previous]]
| [[../|Home]]
| [[../Creating_and_Booting_the_Minimal-Install_Image_on_USB|Next >]]
|}

[[Category:Core system]]

